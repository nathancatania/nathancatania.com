<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <title>Nathan Catania | Deploying a multi-node, multi-server Kafka Cluster with Docker</title>
  
  <meta name="description" content="A Docker deployment of Kafka avoids the need to manually configure each broker and provides a very simple and scalable installation methodology; particularly over multiple servers.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Deploying a multi-node, multi-server Kafka Cluster with Docker">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://localhost:4000/posts/deploying-a-multi-node-kafka-cluster-with-docker">
  <meta property="og:description" content="A Docker deployment of Kafka avoids the need to manually configure each broker and provides a very simple and scalable installation methodology; particularly over multiple servers.">
  <meta property="og:site_name" content="Nathan Catania">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://localhost:4000/posts/deploying-a-multi-node-kafka-cluster-with-docker">
  <meta name="twitter:title" content="Deploying a multi-node, multi-server Kafka Cluster with Docker">
  <meta name="twitter:description" content="A Docker deployment of Kafka avoids the need to manually configure each broker and provides a very simple and scalable installation methodology; particularly over multiple servers.">

  
    <meta property="og:image" content="http://localhost:4000/assets/og-image-226cb427b00014bffc4473c892a2f50e3891290cea42d16cf0e4480ef323507f.jpg">
    <meta name="twitter:image" content="http://localhost:4000/assets/og-image-226cb427b00014bffc4473c892a2f50e3891290cea42d16cf0e4480ef323507f.jpg">
  

  <link href="http://localhost:4000/feed.xml" type="application/rss+xml" rel="alternate" title="Nathan Catania Last 10 blog posts" />

  

  
    <link rel="icon" type="image/x-icon" href="/assets/favicon-light-0fb75e705f4c26badaa4bcdef43cb502633cccf890a2000e372ed03fb65ffdb4.ico">
    <link rel="apple-touch-icon" href="/assets/apple-touch-icon-light-3d53a961ad5a122e83b8efada7f6b8eef7586b54e4bbfc404e98401321b1aeb6.png">
    <link rel="stylesheet" type="text/css" href="/assets/light-77eb19a8e4077f2849834cf5e5f4c759614b49500a652f98ac9e97e2715f905e.css">
  
</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="Nathan Catania">Nathan Catania</a>
  <ul class="header-links">
    
    
    
    
    
      <li>
        <a href="https://github.com/nathancatania" rel="noreferrer noopener" target="_blank" title="GitHub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
  <use href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github" xlink:href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
      <li>
        <a href="https://hub.docker.com/r/nathancatania" rel="noreferrer noopener" target="_blank" title="Docker Hub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-docker">
  <use href="/assets/docker-c339e74d6b786fbde73b16d23c150b731f34e6afba1693051596237af7ff9f2d.svg#icon-docker" xlink:href="/assets/docker-c339e74d6b786fbde73b16d23c150b731f34e6afba1693051596237af7ff9f2d.svg#icon-docker"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="https://www.linkedin.com/in/nathancatania" rel="noreferrer noopener" target="_blank" title="LinkedIn">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-linkedin">
  <use href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin" xlink:href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="mailto:nathan@nathancatania.com" title="Email">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-email">
  <use href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email" xlink:href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" rel="noreferrer noopener" target="_blank" title="RSS">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-rss">
  <use href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss" xlink:href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss"></use>
</svg>

        </a>
      </li>
    
  </ul>
</nav>

        <article class="article scrollappear">
          <header class="article-header">
            <h1>Deploying a multi-node, multi-server Kafka Cluster with Docker</h1>
            <p>A Docker deployment of Kafka avoids the need to manually configure each broker and provides a very simple and scalable installation methodology; particularly over multiple servers.</p>
            <div class="article-list-footer">
              <span class="article-list-date">
                December 15, 2017
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  6 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                  <a href="/tag/guides">guides</a>
                
                  <a href="/tag/docker">docker</a>
                
                  <a href="/tag/kafka">kafka</a>
                
                  <a href="/tag/networking">networking</a>
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <h2 id="what-is-kafka">What is Kafka?</h2>
<p><a href="https://kafka.apache.org/intro.html">Essentially:</a></p>
<blockquote>
  <p>Kafka is an open-source, very scalable, distributed messaging platform by Apache. It is designed to handle large volumes of data in real-time efficiently.</p>
</blockquote>

<p>Kafka works on the concept of a “publish-subscribe” methodology:</p>

<ul>
  <li>“Producers” will push content to the Kafka cluster, to a destination “topic”.</li>
  <li>A Kafka cluster is managed by Zookeeper, and can contain one or more “Brokers”.</li>
  <li>Brokers manage topics and the associated ingress and egress messages.</li>
  <li>“Consumers” subscribe to specific topics and will receive a continuous stream of data from the cluster for as long as there is a Producer pushing content to that topic.</li>
</ul>

<p>Topics have two key properties: <em>partitions</em> and <em>replication factors</em>.</p>
<ul>
  <li><em>Partitions</em> logically separate the messages within a topic into small “groups” which are distributed between all available brokers. For example, if there are 3 brokers in a cluster, and a topic has 6 partitions, Broker #1 might be assigned Partition #3 &amp; #6, Broker #2 - Partition #1 &amp; #5, and Broker #3 - Partition #2 &amp; #4.</li>
  <li>A <em>replication factor</em> helps add redundancy to a topic and its partitions across the available Brokers. Using the example above, if the same topic has a replication factor of 3, then each broker would have a copy of the partitions managed by other brokers in addition to its own. Hence, if a broker goes down, the messages stored in the partitions held by it are not lost.</li>
</ul>

<p>The cool thing about Kafka consumers is that, when they are grouped together and used in conjunction with partitions, they can automatically load balance incoming messages between them!</p>

<p>This is really handy for avoiding Consumer bottlenecks if you are dealing with real-time data in high volumes. If a Consumer cannot process the incoming messages fast enough, it will fall behind and you will begin to notice an increasing delay between the current time and the incoming message. If a second Consumer is added to the same group as the first, and both are subscribed to a topic with 6 partitions, then Consumer #1 might be assigned messages from Partition #1, #2, #5, and Consumer #2 might be assigned messages from Partition #3, #4, #6. This is instead of Consumer #1 bottlenecking by having to process Partitions #1-6 by itself.</p>

<h2 id="why-docker">Why Docker?</h2>
<p>Deploying Kafka in Docker greatly simplifies deployment as we do not need to manually configure each broker individually!</p>

<p>We can use single Docker Compose file to deploy Kafka to multiple server instances using Docker Swarm in a single command. Additionally, Docker allows us to easily scale up our cluster to additional nodes in the future if we require.</p>

<h2 id="requirements">Requirements</h2>
<p>When deployed via Docker, Kafka tends to use approximately 1.3 GB - 1.5 GB of RAM per broker - so make sure your server instances have enough memory allocated and available.</p>

<h2 id="process">Process</h2>
<p>Before proceeding, make sure you have Docker installed on ALL of the servers you wish to deploy Kafka to.</p>

<h3 id="part-1---create-a-docker-swarm">Part 1 - Create a Docker Swarm</h3>
<p>To begin, we need to initialize a Docker Swarm. A Swarm will consist of at least one Master Node, and one or more Worker Nodes (or, if you just have a single server instance, a single Master Node).</p>

<h4 id="1-initialize-the-swarm--master-node">1. Initialize the Swarm &amp; Master Node</h4>
<p>On the server instance you have designated to be the Master, initialize the Swarm. This will set the current instance as the Master node:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker swarm init <span class="nt">--advertise-addr</span> <span class="o">[</span>MANAGER-IP]:2377</code></pre></figure>

<p>Where <code class="highlighter-rouge">[MANAGER-IP]</code> is the static IP address of the server instance.
You can find this using <code class="highlighter-rouge">ifconfig</code>.</p>

<p>This will generate a unique command which you will run on all other nodes in the next section in order to designate them as Worker nodes.</p>

<p>Save this command in a safe place.</p>

<p>Example (<strong>your command and token will be different!</strong>):</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker swarm <span class="nb">join</span> <span class="nt">--token</span> SWMT[...]ewrp <span class="o">[</span>MANAGER-IP]:2377</code></pre></figure>

<h4 id="2-check-your-firewall">2. Check your firewall</h4>
<p>Swarm nodes use port 2377 to communicate with the Master node which must not be blocked by any firewall.</p>

<p>Additionally, Swarm daemons use ports 7946 (tcp/udp) and 4789 (udp) to communicate.</p>

<p>Make sure your all of your instances are able to communicate:</p>
<ul>
  <li>TCP/UDP traffic on ports 2377 and 7946.</li>
  <li>UDP traffic on port 4789.</li>
</ul>

<h4 id="3-configure-the-worker-nodes">3. Configure the Worker Nodes</h4>
<p>On all other server instances you wish to deploy Kafka on, run the command generated in the step #1 above. This will add these instances to the Docker Swarm as Worker Nodes.</p>

<p>If you are having issues:</p>
<ul>
  <li>As per Step #2 above, make sure all your instances can communicate on the specified ports.</li>
  <li>Make sure all of your instances have static IP addresses assigned to them.</li>
</ul>

<h4 id="4-verify-the-swarm">4. Verify the Swarm</h4>
<p>On the <strong>Master Node</strong> only, run the following command to check the status of all nodes in the swarm:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker node <span class="nb">ls</span></code></pre></figure>

<h3 id="part-2---deploying-kafka">Part 2 - Deploying Kafka</h3>
<h4 id="1-create-docker-composeyml">1. Create docker-compose.yml</h4>
<p>Copy the following into a file named <code class="highlighter-rouge">docker-compose.yml</code> on the Master Node:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.2'</span>
<span class="na">services</span><span class="pi">:</span>
   <span class="na">zookeeper</span><span class="pi">:</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">wurstmeister/zookeeper</span>
      <span class="na">ports</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s2">"</span><span class="s">2181:2181"</span>

   <span class="na">kafka</span><span class="pi">:</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">wurstmeister/kafka:latest</span>
      <span class="na">deploy</span><span class="pi">:</span>
         <span class="na">mode</span><span class="pi">:</span> <span class="s">global</span>
      <span class="na">ports</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="na">target</span><span class="pi">:</span> <span class="s">9094</span>
           <span class="na">published</span><span class="pi">:</span> <span class="s">9094</span>
           <span class="na">protocol</span><span class="pi">:</span> <span class="s">tcp</span>
           <span class="na">mode</span><span class="pi">:</span> <span class="s">host</span>
      <span class="na">environment</span><span class="pi">:</span>
         <span class="na">HOSTNAME_COMMAND</span><span class="pi">:</span> <span class="s2">"</span><span class="s">docker</span><span class="nv"> </span><span class="s">info</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">grep</span><span class="nv"> </span><span class="s">^Name:</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">cut</span><span class="nv"> </span><span class="s">-d'</span><span class="nv"> </span><span class="s">'</span><span class="nv"> </span><span class="s">-f</span><span class="nv"> </span><span class="s">2"</span> <span class="c1"># Normal instances</span>
         <span class="c1"># HOSTNAME_COMMAND: "curl http://169.254.169.254/latest/meta-data/public-hostname" # AWS Only</span>
         <span class="na">KAFKA_ZOOKEEPER_CONNECT</span><span class="pi">:</span> <span class="s">zookeeper:2181</span>
         <span class="na">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><span class="pi">:</span> <span class="s">INSIDE:PLAINTEXT,OUTSIDE:PLAINTEXT</span>
         <span class="na">KAFKA_ADVERTISED_PROTOCOL_NAME</span><span class="pi">:</span> <span class="s">OUTSIDE</span>
         <span class="na">KAFKA_ADVERTISED_PORT</span><span class="pi">:</span> <span class="s">9094</span>
         <span class="na">KAFKA_PROTOCOL_NAME</span><span class="pi">:</span> <span class="s">INSIDE</span>
         <span class="na">KAFKA_PORT</span><span class="pi">:</span> <span class="s">9092</span>
         <span class="na">KAFKA_CREATE_TOPICS</span><span class="pi">:</span> <span class="s">myTopic:3:3,anotherTopic:2:2</span>
      <span class="na">volumes</span><span class="pi">:</span>
         <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock</span></code></pre></figure>

<ul>
  <li>The Zookeeper container is responsible for managing the Kafka cluster.</li>
  <li>Using the above configuration, you will be able to connect to your Kafka brokers using port 9094 at their designated IP/hostname.</li>
  <li>Alter <code class="highlighter-rouge">CREATE_KAFKA_TOPICS</code> in to pre-allocate your topic names. Separate multiple topics with commas.
    <ul>
      <li>In the file above, two topics will be created: One with 3 partitions and 3 replications, and another with 2 partitions and 2 replications.</li>
    </ul>
  </li>
  <li>You can specify an <code class="highlighter-rouge">environment</code> entry for most (if not all) Kafka configuration options. For more information, see <a href="https://github.com/wurstmeister/kafka-docker#pre-requisites">here</a>.</li>
</ul>

<p><br /><strong>If you are deploying to AWS!</strong><br />
Comment out the <strong>first</strong> <code class="highlighter-rouge">HOSTNAME_COMMAND</code> line under <code class="highlighter-rouge">environment</code> and uncomment the <strong>second</strong> <code class="highlighter-rouge">HOSTNAME_COMMAND</code>.</p>

<p>There is a different method to resolving the instance hostname for AWS instances, which is critical to Kafka. <strong>Failing to do this will mean that while your broker(s) will be deployed, nothing will be able to find or connect to them.</strong></p>

<h4 id="2-check-your-firewall-again">2. Check your firewall (again)</h4>
<ul>
  <li>Kafka communicates with Zookeeper on port 2181.</li>
  <li>Kafka will listen for connections on 9094 and communicate internally on port 9092.</li>
  <li>Make sure these ports are open for TCP/UDP traffic or you may have communication issues.</li>
</ul>

<h4 id="3-deploy-the-kafka-stack">3. Deploy the Kafka stack</h4>
<p>On the Master Node, run the following command:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker stack deploy <span class="nt">--compose-file</span> docker-compose.yml kafka</code></pre></figure>

<ul>
  <li>This will deploy a Kafka broker to each node in the Swarm, and bring online ONE Zookeeper management container.</li>
  <li>Additionally, any Kafka topics specified in the <code class="highlighter-rouge">docker-compose.yml</code> file will be initialized.</li>
  <li>The deployed service will have the name <code class="highlighter-rouge">kafka</code>.</li>
</ul>

<h4 id="4-verify-status">4. Verify status</h4>
<p>You can use the following command to verify the status of the Kafka stack:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker stack services kafka</code></pre></figure>

<p>The status for all containers should be shown. A successful launch on 3 servers (for example) should show 3/3 replicas for Kafka and 1/1 replicas for Zookeeper.</p>

<h3 id="part-3---stopping-the-cluster">Part 3 - Stopping the cluster</h3>
<p>Simply run the following command on the Master node:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker stack <span class="nb">rm </span>kafka</code></pre></figure>

<h3 id="part-4---sending--receiving-data-using-your-kafka-cluster">Part 4 - Sending &amp; Receiving data using your Kafka cluster</h3>
<p>The Kafka stack deployed above will initialize a single Kafka container on each node within the Swarm. Hence the IP address of each node is the IP address of a Kafka broker within the Kafka cluster.</p>

<p>The Kafka brokers will listen for Consumer applications and Producers on port 9094.</p>

<p>It does not matter which broker IP/hostname you use for the producer/consumer connection.
In many applications or APIs (eg: Telegraf, kafka-python etc) in which you can specify a list of brokers, only the first broker is used. The others are used as fallback (in the specified order) in case the preceding broker is unavailable or down.</p>


          </div>
          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=Deploying+a+multi-node,+multi-server+Kafka+Cluster+with+Docker%20-%20http://localhost:4000/posts/deploying-a-multi-node-kafka-cluster-with-docker" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/posts/deploying-a-multi-node-kafka-cluster-with-docker" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
            <a href="https://plus.google.com/share?url=http://localhost:4000/posts/deploying-a-multi-node-kafka-cluster-with-docker" title="Share on Google+" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 128 128"><path d="M40.7 55.9v16.1c0 0 15.6 0 22 0C59.2 82.5 53.8 88.2 40.7 88.2c-13.3 0-23.7-10.8-23.7-24.2s10.4-24.2 23.7-24.2c7.1 0 11.6 2.5 15.8 5.9 3.3-3.3 3.1-3.8 11.6-11.9 -7.2-6.6-16.8-10.6-27.4-10.6C18.2 23.3 0 41.5 0 64c0 22.5 18.2 40.7 40.7 40.7 33.6 0 41.8-29.3 39-48.8H40.7zM113.9 56.7V42.6h-10.1v14.1H89.4v10.1h14.5v14.5h10.1V66.8H128V56.7H113.9z"/></svg>
            </a>
          </div>

          
        </article>
        <footer class="footer scrollappear">
  <p>
    &copy; 2018, Nathan Catania<br>
    Created with Jekyll using the <a href="https://github.com/nielsenramon/chalk" rel="noreferrer noopener" target="_blank" title="Chalk">Chalk</a> theme.
  </p>
</footer>

      </div>
    </div>
  </main>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-91639797-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-91639797-1');
  </script>


<script src="/assets/vendor-0fb4b91f7ad6c193a69224eba7a01b691a2d7528ee672607575ccc0df3aea545.js" type="text/javascript"></script>


  <script src="/assets/webfonts-a0d47936da5f81bb0c028bc03a81b261df12947928f4762d7c4d58000d49339e.js" type="text/javascript"></script>



  <script src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js" type="text/javascript"></script>


<script src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js" type="text/javascript"></script>

</body>
</html>
